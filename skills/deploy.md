# File Explorer 部署與偵錯機制總結

本文件記錄 File Explorer 專案中實作的自動化部署與品質保證（QA）機制，旨在確保代碼品質、環境安全性及部署後的一致性。

## 1. Git pre-commit Hook
**位置**：`.git/hooks/pre-commit`
**功能**：在執行 `git commit` 前自動觸發 `deploy/precheck.sh`。

### 偵測問題與原因
*   **代碼污染偵測**：防止開發者在測試過程中隨手寫入的 `console.log`、金鑰或測試用連接埠（如 `9999`）進入倉庫。
*   **本地測試遺漏**：強制執行測試套件。若本地環境與遠端環境不一致（如遺漏 `npm install` 某個依賴），Hook 會立即攔截，避免將「本地跑得起來但換台機器就壞掉」的代碼推出去。

---

## 2. Pre-check (預檢機制)
**位置**：`deploy/precheck.sh`

### 偵測問題與原因
*   **敏感資訊硬編碼**：偵測代碼中是否含有疑似 `http://localhost` 或特定私鑰。原因：這些值在生產環境中會失效或造成資安漏洞。
*   **環境變數缺失**：確認 `.env` 是否同步。原因：部署後若缺少必要變數，後端服務會因 `undefined` 引發崩潰。
*   **靜態邏輯錯誤**：透過前端單元測試確認 UI 元件邏輯（如長按、刪除、版本顯示）未因代碼重構而損壞。
*   **API 行為偏差 (沙箱測試)**：在隔離環境啟動後端並傳送真實 Request。
    *   **偵測目標**：回應的 JSON 結構是否改變？二進位檔案下載是否損毀？
    *   **原因**：防止部署後才發現 API 回傳型別錯誤（如 String 變成了 Object），導致前端崩潰。

---

## 3. Post-check (部署後驗證)
**位置**：`deploy/postcheck.sh`

### 偵測問題與原因
*   **服務啟動失敗 (Zombie Process)**：偵測後端程序是否真的在監聽正確的 PORT。原因：有時程序顯示啟動但因內部錯誤卡死。
*   **路由代理失效**：透過 `curl` 外部域名（如 `example.com`）驗證。原因：偵測 Caddy 或反向代理層是否將請求正確導向後端，而非卡在代理層。
*   **路徑偏移與測試環境殘留偵測 (最核心)**：
    *   **機制**：部署完成後，主動抓取瀏覽器會看到的 `main.js`，並從內容搜尋 `process.env.REACT_APP_GIT_SHA`。
    *   **偵測問題**：**偵測「成功部署到錯誤目錄」或「生產環境與測試環境配置混淆」。**
    *   **原因**：偵測部署配置是否誤用了 **`mock_root` (測試用假根目錄)**。本次事件中發現 `EXPLORER_DEPLOY_TARGET` 被設為 `backend/static/`，這原是開發過程中為了進行沙箱整合測試而模擬的 `mock_root`。若正式部署時未切換回真實的生產路徑（`/var/www/file-explorer`），系統會出現「檔案已同步至測試路徑，但生產服務讀取不到」的情況。透過比對對外 JS 內容的 SHA，能立即發現這種「測試配置污染生產配置」的行為。
*   **依賴服務中斷**：檢查與 Google Drive 等第三方 API 的握手狀態。原因：確認部署後的環境變數（金鑰）具備正確權限。

---

## 4. 部署流程整合 (deploy.sh)
### 偵測問題與原因
*   **不一致性提交偵測**：強制執行 `git status --porcelain`。
    *   **偵測問題**：偵測「正在開發中、尚未 commit 的實驗性代碼」。
    *   **原因**：如果允許部署未 commit 的代碼，會導致生產環境的版本無法透過 Git 回溯（Git SHA 會指向舊的 commit，但實際跑的是開發者的臨時改動），造成災難性的除錯難度。

